<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Mobile Phone Dashboard</title>
		<style>
			h2 {
				display: inline;
			}
		</style>
	</head>
	
	<body>
		<input type="button" value="Enable Sensor Access" onclick=enableSensors()>
		<div>
			<h1></h1>
		</div>
		<div>
			<h1>GPS</h1>
		</div>
		<div>
			<h2>Time: </h2>
			<h2 id="time">0</h2>
		</div>
		<div>
			<h2>Speed: </h2>
			<h2 id="speed">0</h2>
		</div>
		<div>
			<h2>Lat: </h2>
			<h2 id="lat">0</h2>
		</div>
		<div>
			<h2>Lon: </h2>
			<h2 id="lon">0</h2>
		</div>
		<div>
			<h2>Accuracy: </h2>
			<h2 id="accuracy">0</h2>
		</div>
		<div>
			<h1>Gyroscope</h1>
		</div>
		<div>
			<h2>Alpha: </h2>
			<h2 id="alpha">0</h2>
		</div>
		<div>
			<h2>Beta: </h2>
			<h2 id="beta">0</h2>
		</div>
		<div>
			<h2>Gamma: </h2>
			<h2 id="gamma">0</h2>
		</div>
		<div>
			<h1>Accelerometer</h1>
		</div>
		<div>
			<h2>X: </h2>
			<h2 id="accelX">0</h2>
		</div>
		<div>
			<h2>Y: </h2>
			<h2 id="accelY">0</h2>
		</div>
		<div>
			<h2>Z: </h2>
			<h2 id="accelZ">0</h2>
		</div>
		<div>
			<h1></h1>
		</div>
		<input type="button" value="Save Recording" onclick=exportToCsv()>
		
		<script>
			var timeseries = [["time", "speed", "lat", "lon", "accuracy", "alpha", "beta", "gamma", "accelX", "accelY", "accelZ"]];
			
			function enableSensors () {
				enableLocation();
				enableOrientation();
				enableMotion();
			}
			
			function addToArray () {
				timeseries.push([
					document.getElementById("time").innerHTML,
					document.getElementById("speed").innerHTML,
					document.getElementById("lat").innerHTML,
					document.getElementById("lon").innerHTML,
					document.getElementById("accuracy").innerHTML,
					document.getElementById("alpha").innerHTML,
					document.getElementById("beta").innerHTML,
					document.getElementById("gamma").innerHTML,
					document.getElementById("accelX").innerHTML,
					document.getElementById("accelY").innerHTML,
					document.getElementById("accelZ").innerHTML
				])
			}
			
			function enableLocation () {
				if (navigator.geolocation) {
					var options = {
						enableHighAccuracy: true,
						timeout: 5000,
						maximumAge: 0
					};
					navigator.geolocation.watchPosition(success, error, options);
				}

				function success(position) {
					document.getElementById("time").innerHTML = position.timestamp;
					document.getElementById("speed").innerHTML = position.coords.speed.toFixed(1);
					document.getElementById("lat").innerHTML = position.coords.latitude;
					document.getElementById("lon").innerHTML = position.coords.longitude;
					document.getElementById("accuracy").innerHTML = position.coords.accuracy.toFixed(0);
					addToArray();
				}
				
				function error(err) {
					console.log("Geolocation Unavailable!");
				}
			}
			
			function enableOrientation () {
				DeviceOrientationEvent.requestPermission().then(response => {
					if (response == "granted") {
						window.addEventListener("deviceorientation", (event) => {
							document.getElementById("alpha").innerHTML = event.alpha.toFixed(0);
							document.getElementById("beta").innerHTML = event.beta.toFixed(0);
							document.getElementById("gamma").innerHTML = event.gamma.toFixed(0);
						})
					}
				})
			}
			
			function enableMotion () {
				DeviceMotionEvent.requestPermission().then(response => {
					if (response == "granted") {
						window.addEventListener("devicemotion", (event) => {
							document.getElementById("accelX").innerHTML = event.acceleration.x.toFixed(1);
							document.getElementById("accelY").innerHTML = event.acceleration.y.toFixed(1);
							document.getElementById("accelZ").innerHTML = event.acceleration.z.toFixed(1);
						})
					}
				})
			}
			
			
			function exportToCsv(filename="test.csv", rows=timeseries) {
				var processRow = function (row) {
					var finalVal = '';
					for (var j = 0; j < row.length; j++) {
						var innerValue = row[j] === null ? '' : row[j].toString();
						if (row[j] instanceof Date) {
							innerValue = row[j].toLocaleString();
						};
						var result = innerValue.replace(/"/g, '""');
						if (result.search(/("|,|\n)/g) >= 0)
							result = '"' + result + '"';
						if (j > 0)
							finalVal += ',';
						finalVal += result;
					}
					return finalVal + '\n';
				};

				var csvFile = '';
				for (var i = 0; i < rows.length; i++) {
					csvFile += processRow(rows[i]);
				}

				var blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
				if (navigator.msSaveBlob) { // IE 10+
					navigator.msSaveBlob(blob, filename);
				} else {
					var link = document.createElement("a");
					if (link.download !== undefined) { // feature detection
						// Browsers that support HTML5 download attribute
						var url = URL.createObjectURL(blob);
						link.setAttribute("href", url);
						link.setAttribute("download", filename);
						link.style.visibility = 'hidden';
						document.body.appendChild(link);
						link.click();
						document.body.removeChild(link);
					}
				}
			}
		</script>
	</body>

</html>
